{% extends "base.html" %}
{% block title %}Chat Room{% endblock %}
{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <h2 class="text-center mb-4">Chat Room</h2>

        <p class="text-center">
            Welcome, {{ request.user.username }}!
        </p>

        <div id="chat" class="card mb-3" style="padding: 10px; max-height: 500px; overflow-y: auto;">
            {% for message in latest_messages %}
            <div class="message {% if message.user == request.user %}me{% else %}other{% endif %}">
                <strong>{{ message.user.username }}</strong>
                <span class="date">{{ message.sent_on|date:"Y.m.d H:i A" }}</span><br>
                {{ message.content }}
            </div>
            {% endfor %}
        </div>

        <div id="chat-input" class="input-group">
            <input id="chat-message-input" type="text" class="form-control" placeholder="Type a message...">
            <button id="chat-message-submit" class="btn btn-primary" type="button">Send</button>
        </div>
    </div>
</div>
{% endblock %}

{% block include_js %}
{{ request.user.username|json_script:"request-user" }}
{% endblock %}

{% block domready %}
const requestUser = JSON.parse(document.getElementById('request-user').textContent);

// Public chat WebSocket
const url = 'ws://' + window.location.host + '/ws/chat/general/';
const chatSocket = new WebSocket(url);

chatSocket.onmessage = function(event) {
    const data = JSON.parse(event.data);
    const chat = document.getElementById('chat');
    const dateOptions = {hour: 'numeric', minute: 'numeric', hour12: true};
    const datetime = new Date(data.datetime).toLocaleString('en', dateOptions);
    const isMe = data.user === requestUser;
    const source = isMe ? 'me' : 'other';
    const name = isMe ? 'Me' : data.user;

    chat.innerHTML += '<div class="message ' + source + '">' +
        '<strong>' + name + '</strong> ' +
        '<span class="date">' + datetime + '</span><br>' +
        data.message + '</div>';

    chat.scrollTop = chat.scrollHeight;
};

chatSocket.onclose = function(event) {
    console.error('Chat socket closed unexpectedly');
};

const input = document.getElementById('chat-message-input');
const submitButton = document.getElementById('chat-message-submit');

submitButton.addEventListener('click', function() {
    const message = input.value;
    if (message) {
        chatSocket.send(JSON.stringify({'message': message}));
        input.value = '';
        input.focus();
    }
});

input.addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        submitButton.click();
    }
});

input.focus();
{% endblock %}

